name: Auto Bug Fix (TDD)

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

concurrency:
  group: bugfix-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  fix-bug:
    # Trigger on: auto-fix label added, OR @claude mention in comment
    if: |
      (github.event_name == 'issues' && github.event.label.name == 'auto-fix') ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    timeout-minutes: 120 # Increased timeout for Opus 4.5 + 50 turns

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Fix bug with Claude Code (TDD)
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_OAUTH_TOKEN }}
          prompt: |
            Fix this runtime error using a strict TDD approach:

            ${{ github.event.issue.body }}

            ## TDD Workflow (follow in order):
            1. **Analyze**: Read the error traceback and server logs and identify the root cause.
            2. **Write Test**: Create a failing unit test that reproduces the bug.
               - Place tests in backend/<module>/tests/test_*.py
               - Use BaseCommandTest from tests/test_base.py as base class
            3. **Verify Fail**: Run the test to confirm it fails with the expected error.
            4. **Implement Fix**: Make the minimal code change to fix the bug.
            5. **Verify Pass**: Run the test again - confirm it passes.
            6. **Run Suite**: Run `./scripts/run_backend_tests.sh` (ensure >80% coverage).
            7. **Commit & PR**:
               - Branch: `fix/issue-${{ github.event.issue.number }}`
               - Commit: `git commit -m "fix: <description>"`
               - PR: `gh pr create --title "Fix: <description>" --body "Fixes #${{ github.event.issue.number }}"`

            ## Project Standards:
            - Tests use unittest.IsolatedAsyncioTestCase
            - Use AsyncMock for async dependencies
            - All functions need type hints
            - Test naming: test_{function_name}_{description}
          claude_args: |
            --model claude-opus-4-5-20251101
            --dangerously-skip-permissions
            --max-turns 100
